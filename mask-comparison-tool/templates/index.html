<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Mask Comparer</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        
        .carousel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #16213e;
            border-radius: 8px;
        }
        
        .carousel-item-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .carousel-item {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
            display: block;
        }
        
        .carousel-item:hover {
            border-color: #0f4c75;
            transform: scale(1.05);
        }
        
        .carousel-item.selected {
            border-color: #3282b8;
        }
        
        .checkmark {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #27ae60;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            pointer-events: none;
        }
        
        .flag-icon {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            pointer-events: none;
        }
        
        .filter-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            background: #0f3460;
            color: #eee;
            transition: background 0.2s;
        }
        
        .filter-btn:hover {
            background: #1a4a7a;
        }
        
        .filter-btn.active {
            background: #3282b8;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .viewer {
            display: none;
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .viewer.active {
            display: block;
        }
        
        .image-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        
        .image-container img {
            max-width: 100%;
            max-height: 70vh;
            display: block;
            border-radius: 4px;
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 8px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 500;
        }
        
        .color-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .color-btn:hover {
            transform: scale(1.05);
        }
        
        .color-btn.red { background: #e74c3c; color: white; }
        .color-btn.green { background: #27ae60; color: white; }
        .color-btn.blue { background: #3498db; color: white; }
        
        .color-btn.active {
            box-shadow: 0 0 0 3px #fff;
        }
        
        input[type="range"] {
            width: 150px;
            accent-color: #3282b8;
        }
        
        .label-section {
            margin-top: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 8px;
        }
        
        .label-section .prefix {
            font-size: 16px;
        }
        
        .label-section select {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            background: #16213e;
            color: #eee;
            font-size: 16px;
            cursor: pointer;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        
        .btn:hover {
            transform: scale(1.02);
        }
        
        .btn-primary {
            background: #27ae60;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2ecc71;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #888;
        }
        
        .filename-display {
            margin-bottom: 5px;
            font-size: 14px;
            color: #888;
        }
        
        .copy-paths {
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
        }
        
        .copy-link {
            font-size: 12px;
            color: #3282b8;
            text-decoration: none;
        }
        
        .copy-link:hover {
            text-decoration: underline;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-nav {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background: #3282b8;
            color: white;
            transition: transform 0.2s, background 0.2s;
        }
        
        .btn-nav:hover {
            background: #4a9ed4;
            transform: scale(1.02);
        }
        
        .btn-nav:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .counter {
            margin-left: auto;
            color: #888;
            font-size: 14px;
        }
    </style>
</head>
<body>
    {% if pairs %}
    <div class="filter-tabs">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="flagged">Manual Edit</button>
        <button class="filter-btn" data-filter="unreviewed">Unreviewed</button>
    </div>
    <div class="carousel">
        {% for pair in pairs %}
        <div class="carousel-item-wrapper" data-has-txt="{{ 'true' if pair.has_txt else 'false' }}" data-has-flag="{{ 'true' if pair.has_flag else 'false' }}">
            <img 
                class="carousel-item" 
                src="{{ pair.input }}" 
                data-filename="{{ pair.filename }}"
                data-input="{{ pair.input }}"
                data-output="{{ pair.output }}"
                data-has-txt="{{ 'true' if pair.has_txt else 'false' }}"
                data-has-flag="{{ 'true' if pair.has_flag else 'false' }}"
                data-input-path="{{ pair.input_full_path }}"
                data-output-path="{{ pair.output_full_path }}"
                alt="{{ pair.filename }}"
            >
            {% if pair.has_flag %}
            <span class="flag-icon">!</span>
            {% elif pair.has_txt %}
            <span class="checkmark">✓</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div class="viewer" id="viewer">
        <div class="nav-buttons">
            <button class="btn-nav" id="prev-btn">← Previous</button>
            <button class="btn-nav" id="next-btn">Next →</button>
            <span class="counter" id="counter"></span>
        </div>
        <div class="filename-display" id="filename-display"></div>
        <div class="copy-paths">
            <a href="#" class="copy-link" id="copy-input" title="Copy input path">Copy input path</a>
            <a href="#" class="copy-link" id="copy-output" title="Copy output path">Copy output path</a>
        </div>
        <div class="image-container">
            <img id="base-image" src="" alt="Base image">
            <img class="overlay" id="overlay-image" src="" alt="Mask overlay">
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Mask Color:</label>
                <button class="color-btn red active" data-color="red">Red</button>
                <button class="color-btn green" data-color="green">Green</button>
                <button class="color-btn blue" data-color="blue">Blue</button>
            </div>
            
            <div class="control-group">
                <label>Opacity: <span id="opacity-value">50</span>%</label>
                <input type="range" id="opacity-slider" min="0" max="100" value="50">
            </div>
        </div>
        
        <div class="label-section">
            <span class="prefix">Create a black and white alpha mask of the object outlined in </span>
            <select id="label-color">
                <option value="blue">blue</option>
                <option value="green">green</option>
                <option value="red">red</option>
                <option value="yellow">yellow</option>
            </select>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" id="confirm-btn">Looks Good</button>
            <button class="btn btn-warning" id="flag-btn">Flag for Edit</button>
            <button class="btn btn-danger" id="delete-btn">Delete Pair</button>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <h2>No image pairs found</h2>
        <p>Make sure both directories contain matching image files.</p>
    </div>
    {% endif %}
    
    <script>
        const overlay = document.getElementById('overlay-image');
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityValue = document.getElementById('opacity-value');
        const colorBtns = document.querySelectorAll('.color-btn');
        const allCarouselItems = Array.from(document.querySelectorAll('.carousel-item'));
        const viewer = document.getElementById('viewer');
        const baseImage = document.getElementById('base-image');
        const filenameDisplay = document.getElementById('filename-display');
        const labelColor = document.getElementById('label-color');
        const confirmBtn = document.getElementById('confirm-btn');
        const flagBtn = document.getElementById('flag-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const counter = document.getElementById('counter');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const wrappers = document.querySelectorAll('.carousel-item-wrapper');
        
        let currentIndex = -1;
        let currentPair = null;
        let currentColor = 'red';
        let currentOpacity = 0.5;
        let currentFilter = 'all';
        
        const colorFilters = {
            red: 'sepia(100%) saturate(1000%) hue-rotate(-30deg)',
            green: 'sepia(100%) saturate(1000%) hue-rotate(90deg)',
            blue: 'sepia(100%) saturate(1000%) hue-rotate(180deg)'
        };
        
        function getFilteredItems() {
            return allCarouselItems.filter(item => {
                const hasTxt = item.dataset.hasTxt === 'true';
                const hasFlag = item.dataset.hasFlag === 'true';
                if (currentFilter === 'all') return true;
                if (currentFilter === 'flagged') return hasFlag;
                if (currentFilter === 'unreviewed') return !hasTxt && !hasFlag;
                return true;
            });
        }
        
        function updateVisibility() {
            allCarouselItems.forEach(item => {
                const wrapper = item.parentElement;
                const hasTxt = item.dataset.hasTxt === 'true';
                const hasFlag = item.dataset.hasFlag === 'true';
                let visible = true;
                if (currentFilter === 'flagged') visible = hasFlag;
                if (currentFilter === 'unreviewed') visible = !hasTxt && !hasFlag;
                wrapper.style.display = visible ? 'inline-block' : 'none';
            });
        }
        
        function updateNavButtons() {
            const filtered = getFilteredItems();
            prevBtn.disabled = currentIndex <= 0;
            nextBtn.disabled = currentIndex >= filtered.length - 1;
            counter.textContent = `${currentIndex + 1} / ${filtered.length}`;
        }
        
        function updateOverlayStyle() {
            overlay.style.filter = colorFilters[currentColor];
            overlay.style.opacity = currentOpacity;
        }
        
        function selectItem(index) {
            const filtered = getFilteredItems();
            if (index < 0 || index >= filtered.length) return;
            
            currentIndex = index;
            const item = filtered[index];
            
            allCarouselItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            currentPair = {
                filename: item.dataset.filename,
                input: item.dataset.input,
                output: item.dataset.output,
                inputPath: item.dataset.inputPath,
                outputPath: item.dataset.outputPath
            };
            
            baseImage.src = currentPair.input;
            overlay.src = currentPair.output;
            filenameDisplay.textContent = currentPair.filename;
            viewer.classList.add('active');
            updateNavButtons();
        }
        
        function goToNext() {
            const filtered = getFilteredItems();
            if (currentIndex < filtered.length - 1) {
                selectItem(currentIndex + 1);
            }
        }
        
        function goToPrev() {
            if (currentIndex > 0) {
                selectItem(currentIndex - 1);
            }
        }
        
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateVisibility();
                currentIndex = -1;
                viewer.classList.remove('active');
            });
        });
        
        colorBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                colorBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentColor = btn.dataset.color;
                updateOverlayStyle();
            });
        });
        
        opacitySlider.addEventListener('input', (e) => {
            currentOpacity = e.target.value / 100;
            opacityValue.textContent = e.target.value;
            updateOverlayStyle();
        });
        
        allCarouselItems.forEach((item) => {
            item.addEventListener('click', () => {
                const filtered = getFilteredItems();
                const index = filtered.indexOf(item);
                if (index !== -1) {
                    selectItem(index);
                }
            });
        });
        
        prevBtn.addEventListener('click', goToPrev);
        nextBtn.addEventListener('click', goToNext);
        
        confirmBtn.addEventListener('click', async () => {
            if (!currentPair) return;
            
            const color = labelColor.value;
            
            try {
                const response = await fetch('/api/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentPair.filename,
                        color: color
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    const filtered = getFilteredItems();
                    const item = filtered[currentIndex];
                    const wrapper = item.parentElement;
                    item.dataset.hasTxt = 'true';
                    item.dataset.hasFlag = 'false';
                    wrapper.dataset.hasTxt = 'true';
                    wrapper.dataset.hasFlag = 'false';
                    
                    const existingFlag = wrapper.querySelector('.flag-icon');
                    if (existingFlag) existingFlag.remove();
                    
                    if (!wrapper.querySelector('.checkmark')) {
                        const checkmark = document.createElement('span');
                        checkmark.className = 'checkmark';
                        checkmark.textContent = '✓';
                        wrapper.appendChild(checkmark);
                    }
                    
                    updateVisibility();
                    if (currentFilter !== 'all') {
                        const newFiltered = getFilteredItems();
                        if (newFiltered.length === 0) {
                            viewer.classList.remove('active');
                        } else {
                            if (currentIndex >= newFiltered.length) {
                                currentIndex = newFiltered.length - 1;
                            }
                            selectItem(currentIndex);
                        }
                    } else {
                        goToNext();
                    }
                }
            } catch (err) {
                alert('Error saving: ' + err.message);
            }
        });
        
        flagBtn.addEventListener('click', async () => {
            if (!currentPair) return;
            
            try {
                const response = await fetch('/api/flag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: currentPair.filename })
                });
                
                const result = await response.json();
                if (result.success) {
                    const filtered = getFilteredItems();
                    const item = filtered[currentIndex];
                    const wrapper = item.parentElement;
                    item.dataset.hasFlag = 'true';
                    wrapper.dataset.hasFlag = 'true';
                    
                    const existingCheck = wrapper.querySelector('.checkmark');
                    if (existingCheck) existingCheck.remove();
                    
                    if (!wrapper.querySelector('.flag-icon')) {
                        const flagIcon = document.createElement('span');
                        flagIcon.className = 'flag-icon';
                        flagIcon.textContent = '!';
                        wrapper.appendChild(flagIcon);
                    }
                    
                    updateVisibility();
                    if (currentFilter === 'unreviewed') {
                        const newFiltered = getFilteredItems();
                        if (newFiltered.length === 0) {
                            viewer.classList.remove('active');
                        } else {
                            if (currentIndex >= newFiltered.length) {
                                currentIndex = newFiltered.length - 1;
                            }
                            selectItem(currentIndex);
                        }
                    } else {
                        goToNext();
                    }
                }
            } catch (err) {
                alert('Error flagging: ' + err.message);
            }
        });
        
        deleteBtn.addEventListener('click', async () => {
            if (!currentPair) return;
            
            if (!confirm(`Delete ${currentPair.filename} and its pair?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: currentPair.filename })
                });
                
                const result = await response.json();
                if (result.success) {
                    const filtered = getFilteredItems();
                    const itemToDelete = filtered[currentIndex];
                    const wrapper = itemToDelete.parentElement;
                    const indexInAll = allCarouselItems.indexOf(itemToDelete);
                    
                    wrapper.remove();
                    allCarouselItems.splice(indexInAll, 1);
                    
                    const newFiltered = getFilteredItems();
                    if (newFiltered.length === 0) {
                        location.reload();
                    } else {
                        if (currentIndex >= newFiltered.length) {
                            currentIndex = newFiltered.length - 1;
                        }
                        selectItem(currentIndex);
                    }
                }
            } catch (err) {
                alert('Error deleting: ' + err.message);
            }
        });
        
        const copyInputBtn = document.getElementById('copy-input');
        const copyOutputBtn = document.getElementById('copy-output');
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // brief visual feedback could be added here
            });
        }
        
        copyInputBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPair && currentPair.inputPath) {
                copyToClipboard(currentPair.inputPath);
            }
        });
        
        copyOutputBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPair && currentPair.outputPath) {
                copyToClipboard(currentPair.outputPath);
            }
        });
        
        updateOverlayStyle();
    </script>
</body>
</html>
